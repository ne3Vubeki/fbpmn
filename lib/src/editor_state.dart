import 'package:flutter/material.dart';

import 'models/image_tile.dart';
import 'models/snap_line.dart';
import 'models/table.node.dart';
import 'models/arrow.dart';

/// Глобальное состояние редактора BPMN.
///
/// Хранит все данные, необходимые для работы холста: масштаб, позицию,
/// узлы, стрелки, тайлы, настройки отображения и состояние ввода.
/// Инициализируется из [properties], переданных при запуске приложения.
class EditorState {
  /// Свойства, переданные при инициализации приложения (из JS-окружения).
  /// Секция `config` используется для настройки начального состояния редактора.
  final Map<String, dynamic> properties;

  EditorState(this.properties) {
    _applyConfig();
  }

  /// Применяет начальную конфигурацию из [properties]['config'].
  void _applyConfig() {
    final config = properties['config'];
    if (config == null) return;

    for (final entry in (config as Map<String, dynamic>).entries) {
      switch (entry.key) {
        case 'snapEnabled':
          snapEnabled = entry.value as bool;
        case 'showTileBorders':
          showTileBorders = entry.value as bool;
        case 'useCurves':
          useCurves = entry.value as bool;
        case 'showPerformance':
          showPerformance = entry.value as bool;
        case 'showThumbnail':
          showThumbnail = entry.value as bool;
      }
    }
  }

  // ---------------------------------------------------------------------------
  // Масштаб и позиция холста
  // ---------------------------------------------------------------------------

  /// Текущий масштаб холста (1.0 = 100%).
  double scale = 1.0;

  /// Смещение холста относительно начала координат.
  Offset offset = Offset.zero;

  /// Дельта смещения при панорамировании.
  Offset delta = Offset.zero;

  // ---------------------------------------------------------------------------
  // Идентификация
  // ---------------------------------------------------------------------------

  /// Глобальный счётчик-идентификатор для генерации уникальных ID элементов.
  String globalId = '0000000000001';

  // ---------------------------------------------------------------------------
  // Состояние ввода
  // ---------------------------------------------------------------------------

  /// Зажата ли клавиша Shift.
  bool isShiftPressed = false;

  /// Зажата ли клавиша Ctrl.
  bool isCtrlPressed = false;

  /// Выполняется ли панорамирование холста (drag пустого пространства).
  bool isPanning = false;

  /// Текущая позиция курсора мыши в координатах холста.
  Offset mousePosition = Offset.zero;

  // ---------------------------------------------------------------------------
  // Размеры и инициализация
  // ---------------------------------------------------------------------------

  /// Размер видимой области (viewport).
  Size viewportSize = Size.zero;

  /// Флаг завершения первичной инициализации холста.
  bool isInitialized = false;

  // ---------------------------------------------------------------------------
  // Узлы
  // ---------------------------------------------------------------------------

  /// Список всех узлов на холсте.
  final List<TableNode> nodes = [];

  /// Множество выделенных узлов.
  final Set<TableNode?> nodesSelected = {};

  /// Находится ли перетаскиваемый узел на верхнем слое отрисовки.
  bool isNodeOnTopLayer = false;

  /// Исходная позиция узла до начала перетаскивания.
  Offset originalNodePosition = Offset.zero;

  /// Выполняется ли перетаскивание узла.
  bool isNodeDragging = false;

  /// Смещение курсора относительно левого верхнего угла перетаскиваемого узла.
  Offset selectedNodeOffset = Offset.zero;

  /// Внутренние отступы рамки выделения узла.
  EdgeInsets framePadding = EdgeInsets.all(0);

  // ---------------------------------------------------------------------------
  // Наведение на атрибуты узла
  // ---------------------------------------------------------------------------

  /// ID узла, над строкой атрибута которого находится курсор.
  String? hoveredAttributeNodeId;

  /// Индекс строки атрибута, над которой находится курсор.
  int? hoveredAttributeRowIndex;

  /// Курсор над левым кружком связи атрибута.
  bool hoveredAttributeCircleLeft = false;

  /// Курсор над правым кружком связи атрибута.
  bool hoveredAttributeCircleRight = false;

  // ---------------------------------------------------------------------------
  // Snap-прилипание
  // ---------------------------------------------------------------------------

  /// Активные snap-линии, отображаемые при перетаскивании узла.
  List<SnapLine> snapLines = [];

  /// Включено ли snap-прилипание узлов к сетке и другим узлам.
  bool snapEnabled = false;

  // ---------------------------------------------------------------------------
  // Стрелки (связи)
  // ---------------------------------------------------------------------------

  /// Список всех стрелок (связей) на холсте.
  final List<Arrow> arrows = [];

  /// Множество выделенных стрелок.
  final Set<Arrow?> arrowsSelected = {};

  // ---------------------------------------------------------------------------
  // Подсветка
  // ---------------------------------------------------------------------------

  /// ID узлов, подсвеченных как связанные с текущим выделением.
  final Set<String> highlightedNodeIds = {};

  // ---------------------------------------------------------------------------
  // Тайлы (растровый кэш холста)
  // ---------------------------------------------------------------------------

  /// Список тайлов, на которые разбит холст для оптимизации отрисовки.
  List<ImageTile> imageTiles = [];

  /// ID тайлов, требующих перерисовки.
  Set<String> imageTilesChanged = {};

  /// Отображать ли границы тайлов (для отладки).
  bool showTileBorders = true;

  // ---------------------------------------------------------------------------
  // Прочие флаги состояния
  // ---------------------------------------------------------------------------

  /// Выполняется ли асинхронная загрузка данных.
  bool isLoading = false;

  /// Режим автораскладки: скрывает рамки выделения во время расчёта layout.
  bool isAutoLayoutMode = false;

  /// Использовать ли кривые Безье для отрисовки стрелок.
  bool useCurves = false;

  /// Отображать ли миниатюру (thumbnail) холста.
  bool showThumbnail = true;

  /// Отображать ли панель производительности (FPS и прочее).
  bool showPerformance = false;
}
